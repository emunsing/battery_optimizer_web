# Goal

This is to demonstrate a proof-of-concept for using a WebAssembly-based in-browser Linear Programming solver like [CLP-Wasm](https://github.com/centrifuge/clp-wasm) to do battery optimization.

The goal is to be able to provide a tool where a user could upload a year's meter data, and get an estimate of their electrical bill when properly optimized using a home battery.  Being able to run this in-browser should be achievable based on benchmark performance with running CLP through CVXPy on a single core, in which we would expect to be able to optimize a full year's hourly data (8760 hours, ~45k variables) in about one second.

Current status: Initial POC showing optimization for short periods is demonstrated, but speed is much slower than expected (13s for 500 rows of battery data). Final parsing of 

## 1. Python tooling:
An initial prototype was developed, initially in a notebook and then in Gradio to show a server/client MVP.  The Battery_Scratch.ipynb demonstrates the flow, and can be used to generate static data files for use in the pure-Javascript version.

Representative solar generation data is created using PV-lib, and saved to a static cached file.  Because PVLib only uses historical years up to 2023, a bit of manipulation is needed to line this up with current (2024) data, particularly including the 2024 leap-year.

Required packages:
- jupyter
- cvxpy
- numpy
- pandas
- pvlib
- gradio


## 2. CLP-Wasm setup

The [CLP-Wasm browser-based LP solver example](https://centrifuge.github.io/clp-wasm/) was used as an example, with the "lower level API" ultimately chosen for its mathematical cleanliness.

To get this example to run locally, I needed to build the code with `npm install; npm run build`. To resolve an issue with the `Boost` library location in the Dockerfile, I created a fork which is [currently waiting to be merged here](https://github.com/emunsing/clp-wasm/tree/update_boost_version). 

As a first check, ensure that you can run the CLP-Wasm example/index.html locally (e.g. using `live-server`).

## 3. Battery optimization demo

This battery optimization model currently does not use full PGE meter data CSV data, but rather just simplified data generated by the Python notebook (merged tariff/load/solar data, no datetimeindex). 

Currently, output is just raw text.

# Status and TODO

Current performance is very slow and fails for larger models (200ms for ~100 rows of meter data, 13s for 500 rows of meter data, and failures on larger models). Without a clear understanding of this performance gap between CLP run locally through CVXPy (which can have high overhead) and CLP-Wasm, there doesn't seem to be a compelling case to push this forward.

## TODO

[ ] Performance issues: Why is CLP-Wasm so slow? Are there existing benchmarks?
[ ] Error handling
[ ] Deploy to Github Pages
[ ] Plotting / visualization of results
[ ] Datetime indexing and adaptation for tariffs
